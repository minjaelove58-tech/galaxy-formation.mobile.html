<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Galaxy Formation Simulator â€” Mobile Ready</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  background:#000;
  color:#fff;
  font-family:system-ui,Segoe UI,Arial,sans-serif;
}
canvas{
  position:absolute;
  top:0;
  left:0;
  z-index:0;
  touch-action:none; /* ëª¨ë°”ì¼ ì œìŠ¤ì²˜ë¥¼ ìº”ë²„ìŠ¤ê°€ ë°›ê²Œ */
}

/* ê³µí†µ UI ë ˆì´ì–´ */
#menu,#hud,#panel,#playbox,#backbox{
  position:absolute;
  z-index:10;
}

/* ---------- ë©”ì¸ ë©”ë‰´ (ì¤‘ì•™ ì •ë ¬) ---------- */
#menu{
  inset:0;
  background:radial-gradient(circle at center,#020212 10%,#000 90%);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
  box-sizing:border-box;
  text-align:center;
}
.menu-inner{
  width:100%;
  max-width:540px;
  margin:0 auto;
}
.menu-title{
  font-size:28px;
  font-weight:700;
  color:#00eaff;
  margin-bottom:16px;
}
.menu-sub{
  font-size:15px;
  opacity:.8;
  margin-bottom:25px;
}

/* ì€í•˜ íƒ€ì… ì„ íƒ ë²„íŠ¼ë“¤ */
.galaxy-options{
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  justify-content:center;
  margin-bottom:25px;
}
.gal-btn{
  flex:1 1 200px;
  max-width:220px;
  min-width:140px;
  height:90px;
  border:2px solid #00bfff;
  border-radius:10px;
  background:rgba(0,10,40,.6);
  color:#fff;
  cursor:pointer;
  transition:.25s;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:15px;
  box-sizing:border-box;
}
.gal-btn:hover{
  background:#00bfff;
  color:#000;
  transform:scale(1.05);
}
.gal-btn.active{
  background:#00eaff;
  color:#000;
  border-color:#fff;
}

/* ì‹œì‘ ë²„íŠ¼ */
.start-btn{
  background:#00bfff;
  color:#000;
  border:0;
  border-radius:8px;
  font-size:16px;
  padding:10px 26px;
  cursor:pointer;
  font-weight:600;
}
.start-btn:hover{
  background:#00ffff;
}

/* ì„¸ì…˜ ë¦¬ìŠ¤íŠ¸ */
#sessionList{
  margin-top:25px;
  text-align:left;
  width:100%;
  max-width:380px;
  max-height:150px;
  margin-left:auto;
  margin-right:auto;
  overflow-y:auto;
  font-size:13px;
}
.session-entry{
  padding:6px 10px;
  border-radius:8px;
  margin-bottom:6px;
  background:rgba(0,0,30,.5);
  cursor:pointer;
  transition:.2s;
}
.session-entry:hover{
  background:rgba(0,100,200,.7);
}

/* ---------- HUD / íŒ¨ë„ / ë²„íŠ¼ ---------- */
#hud{
  top:12px;
  left:12px;
  background:rgba(0,0,25,.7);
  padding:8px 14px;
  border-radius:8px;
  backdrop-filter:blur(8px);
  display:none;
}
#hud .title{
  font-weight:700;
  color:#00eaff;
  margin-bottom:4px;
}

#panel{
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,25,.8);
  padding:8px 14px;
  border-radius:10px;
  display:none;
  gap:14px;
  align-items:flex-start;
  justify-content:center;
  backdrop-filter:blur(8px);
}
#panel label{
  font-size:12px;
  opacity:.9;
  display:flex;
  flex-direction:column;
  gap:4px;
}
input[type=range]{
  accent-color:#00eaff;
  height:6px;
  border-radius:5px;
}

#playbox,#backbox{
  top:15px;
  padding:8px 12px;
  border-radius:8px;
  background:rgba(0,0,40,.7);
  display:none;
}
#playbox{ right:15px; }
#backbox{ left:15px; }

button{
  background:#008cff;
  color:#fff;
  border:0;
  border-radius:6px;
  padding:6px 14px;
  cursor:pointer;
  font-size:13px;
}
button:hover{
  background:#00aaff;
}

/* ---------- ëª¨ë°”ì¼ ì¡°ì • ---------- */
@media (max-width: 700px){
  .menu-title{ font-size:24px; }
  .menu-sub{ font-size:14px; }
  .gal-btn{
    flex:1 1 100%;
    max-width:none;
  }
  #sessionList{
    font-size:12px;
  }
  #panel{
    bottom:8px;
    padding:6px 10px;
    flex-wrap:wrap;
  }
  #panel label{
    width:100%;
  }
}
</style>
</head>
<body>
<canvas id="bg"></canvas>

<!-- ë©”ì¸ ë©”ë‰´ -->
<div id="menu">
  <div class="menu-inner">
    <div class="menu-title">ğŸª Choose Your Galaxy Type</div>
    <div class="menu-sub">ì‹œë®¬ë ˆì´ì…˜í•  ì€í•˜ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜, ì§€ë‚œ ê¸°ë¡ì„ ì´ì–´ë³´ì„¸ìš”</div>

    <div class="galaxy-options">
      <div class="gal-btn" data-type="spiral">ğŸŒŒ Spiral</div>
      <div class="gal-btn" data-type="elliptical">ğŸ”µ Elliptical</div>
      <div class="gal-btn" data-type="irregular">â˜ï¸ Irregular</div>
      <div class="gal-btn" data-type="milkyway">ğŸŒ Milky Wayâ€“like</div>
    </div>

    <button class="start-btn" id="startSim">Start Simulation â–¶</button>

    <div id="sessionList"></div>
  </div>
</div>

<!-- HUD -->
<div id="hud">
  <div class="title">Galaxy Formation</div>
  <div id="stats">t=0.00 | âŸ¨Ï‰âŸ©=â€“ | core Ï=â€“ | N=â€“</div>
</div>

<!-- í•˜ë‹¨ íŒ¨ë„ -->
<div id="panel">
  <label>â³ Time
    <input id="time" type="range" min="0" max="100" value="0" style="width:200px;">
  </label>
  <label>â© Speed
    <input id="speed" type="range" min="0.1" max="5" value="0.5" step="0.1" style="width:100px;">
  </label>
  <label>ğŸ’¥ SN Rate
    <input id="snRate" type="range" min="0" max="0.01" step="0.0005" value="0.002" style="width:100px;">
  </label>
</div>

<!-- í”Œë ˆì´ / ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
<div id="playbox"><button id="playBtn">â–¶ Play</button></div>
<div id="backbox"><button id="backBtn">ğŸ”™ Back</button></div>

<script>
/* ---------- Three.js ê¸°ë³¸ ---------- */
const renderer = new THREE.WebGLRenderer({antialias:true,canvas:bg});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
renderer.setClearColor(0x000000);
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,8000);

let rCam=1100, theta=0.6, phi=1.05;
function updateCam(){
  camera.position.set(
    rCam*Math.sin(phi)*Math.cos(theta),
    rCam*Math.cos(phi),
    rCam*Math.sin(phi)*Math.sin(theta)
  );
  camera.lookAt(0,0,0);
}
updateCam();

/* ---------- LocalStorage ì„¸ì…˜ ì €ì¥ ---------- */
function loadHistory(){
  const h = localStorage.getItem("galaxyHistory");
  return h ? JSON.parse(h) : [];
}
function saveHistory(list){
  localStorage.setItem("galaxyHistory", JSON.stringify(list.slice(-5)));
}
function addHistory(entry){
  const list = loadHistory();
  list.push(entry);
  saveHistory(list);
}
function renderHistoryList(){
  const list = loadHistory();
  const box = document.getElementById("sessionList");
  if(list.length===0){
    box.innerHTML = "<i style='opacity:.7'>(No previous sessions)</i>";
    return;
  }
  box.innerHTML = "<b>Recent Sessions</b><br>";
  list.slice().reverse().forEach(s=>{
    const div = document.createElement("div");
    div.className = "session-entry";
    div.textContent = `${s.type.toUpperCase()} | t=${(s.time/100).toFixed(2)} | Speed=${s.speed} | SN=${s.snRate}`;
    div.onclick = ()=>restoreSession(s);
    box.appendChild(div);
  });
}
function restoreSession(s){
  selectedGalaxy = s.type;
  document.querySelectorAll('.gal-btn').forEach(b=>b.classList.remove('active'));
  const btn = document.querySelector(`.gal-btn[data-type='${s.type}']`);
  if(btn) btn.classList.add('active');

  time.value  = s.time;
  speed.value = s.speed;
  snRate.value= s.snRate;

  menu.style.display   = 'none';
  hud.style.display    = 'block';
  panel.style.display  = 'flex';
  playbox.style.display= 'block';
  backbox.style.display= 'block';

  startSimulation(s.type);
  setTimeout(()=>playBtn.click(), 600);
}

/* ---------- ìº”ë²„ìŠ¤ í¬ì¸í„° ì œì–´ (ëª¨ë°”ì¼+PC ê³µí†µ íšŒì „/ì¤Œ) ---------- */
const activePointers = new Map(); // id -> {x,y}
let rotStartTheta=0, rotStartPhi=0, rotStartPos={x:0,y:0};
let pinchStartDist=null, pinchStartR=rCam;

// pointer down
bg.addEventListener("pointerdown", e=>{
  if(e.button!==undefined && e.button!==0) return;
  activePointers.set(e.pointerId, {x:e.clientX,y:e.clientY});
  bg.setPointerCapture(e.pointerId);

  if(activePointers.size===1){
    const p = activePointers.values().next().value;
    rotStartPos = {x:p.x,y:p.y};
    rotStartTheta = theta;
    rotStartPhi   = phi;
    pinchStartDist = null;
  }else if(activePointers.size===2){
    const it = activePointers.values();
    const p1 = it.next().value;
    const p2 = it.next().value;
    const dx = p2.x-p1.x;
    const dy = p2.y-p1.y;
    pinchStartDist = Math.hypot(dx,dy)||1;
    pinchStartR    = rCam;
  }
});

// pointer move
window.addEventListener("pointermove", e=>{
  if(!activePointers.has(e.pointerId)) return;
  activePointers.set(e.pointerId,{x:e.clientX,y:e.clientY});

  if(activePointers.size===1){
    const p = activePointers.values().next().value;
    const dx = p.x-rotStartPos.x;
    const dy = p.y-rotStartPos.y;
    theta = rotStartTheta - dx*0.005;
    phi   = rotStartPhi   - dy*0.005;
    phi   = Math.max(0.1, Math.min(Math.PI-0.1, phi));
    updateCam();
  }else if(activePointers.size===2){
    const it = activePointers.values();
    const p1 = it.next().value;
    const p2 = it.next().value;
    const dx = p2.x-p1.x;
    const dy = p2.y-p1.y;
    const dist = Math.hypot(dx,dy)||1;
    if(pinchStartDist!=null){
      const factor = pinchStartDist/dist;
      rCam = pinchStartR*factor;
      rCam = Math.max(350,Math.min(2600,rCam));
      updateCam();
    }else{
      pinchStartDist = dist;
      pinchStartR = rCam;
    }
  }
});

// pointer up/cancel
function endPointer(e){
  if(!activePointers.has(e.pointerId)) return;
  activePointers.delete(e.pointerId);
  try{ bg.releasePointerCapture(e.pointerId); }catch(_){}
  if(activePointers.size===1){
    const p = activePointers.values().next().value;
    rotStartPos={x:p.x,y:p.y};
    rotStartTheta=theta;
    rotStartPhi=phi;
    pinchStartDist=null;
  }else if(activePointers.size===0){
    pinchStartDist=null;
  }
}
window.addEventListener("pointerup", endPointer);
window.addEventListener("pointercancel", endPointer);

// íœ  ì¤Œ (PC)
bg.addEventListener("wheel", e=>{
  e.preventDefault();
  rCam *= 1 + Math.sign(e.deltaY)*0.12;
  rCam = Math.max(350,Math.min(2600,rCam));
  updateCam();
},{passive:false});

/* ---------- ì€í•˜ ìƒì„± ---------- */
let COUNT=16000, positions, colors, r0, ang0, y0, omega0, snTimer, geo, mat, stars;
function createGalaxy(type){
  if(stars){
    scene.remove(stars);
    stars.geometry.dispose();
    stars.material.dispose();
  }
  positions=new Float32Array(COUNT*3);
  colors   =new Float32Array(COUNT*3);
  r0       =new Float32Array(COUNT);
  ang0     =new Float32Array(COUNT);
  y0       =new Float32Array(COUNT);
  omega0   =new Float32Array(COUNT);
  snTimer  =new Float32Array(COUNT);

  for(let i=0;i<COUNT;i++){
    let rr,yy;
    if(type==='elliptical'){
      rr=Math.pow(Math.random(),0.4)*450+10;
      yy=(Math.random()-0.5)*350;
    }else if(type==='irregular'){
      rr=Math.pow(Math.random(),0.6)*600+40;
      yy=(Math.random()-0.5)*300;
    }else if(type==='milkyway'){
      rr=Math.pow(Math.random(),0.9)*700+40;
      yy=(Math.random()-0.5)*70;
    }else{ // spiral
      rr=Math.pow(Math.random(),0.9)*650+40;
      yy=(Math.random()-0.5)*90;
    }
    const aa=Math.random()*Math.PI*2;
    const MU=(type==='elliptical'?100000:160000);

    r0[i]=rr;
    ang0[i]=aa;
    y0[i]=yy;
    omega0[i]=Math.sqrt(MU/Math.pow(rr+1e-3,3));

    positions[i*3]  = rr*Math.cos(aa);
    positions[i*3+1]= yy;
    positions[i*3+2]= rr*Math.sin(aa);

    colors[i*3]  =0.65;
    colors[i*3+1]=0.78;
    colors[i*3+2]=1.0;
    snTimer[i]=0;
  }

  geo=new THREE.BufferGeometry();
  geo.setAttribute('position',new THREE.BufferAttribute(positions,3));
  geo.setAttribute('color',   new THREE.BufferAttribute(colors,3));
  mat=new THREE.PointsMaterial({
    size:2,
    vertexColors:true,
    transparent:true,
    opacity:0.95
  });
  stars=new THREE.Points(geo,mat);
  scene.add(stars);
}

/* ---------- ë©”ë‰´ â†’ ì‹œë®¬ë ˆì´ì…˜ ---------- */
let selectedGalaxy=null;
let isPlaying=false;

const menu    = document.getElementById('menu');
const hud     = document.getElementById('hud');
const panel   = document.getElementById('panel');
const playbox = document.getElementById('playbox');
const backbox = document.getElementById('backbox');
const playBtn = document.getElementById('playBtn');
const statsEl = document.getElementById('stats');
const time    = document.getElementById('time');
const speed   = document.getElementById('speed');
const snRate  = document.getElementById('snRate');

document.querySelectorAll('.gal-btn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.gal-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    selectedGalaxy = btn.dataset.type;
  };
});

document.getElementById('startSim').onclick=()=>{
  if(!selectedGalaxy){
    alert("ì€í•˜ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
    return;
  }
  menu.style.display='none';
  hud.style.display='block';
  panel.style.display='flex';
  playbox.style.display='block';
  backbox.style.display='block';
  startSimulation(selectedGalaxy);
};

function startSimulation(type){
  createGalaxy(type);

  isPlaying=false;
  let last = performance.now();

  playBtn.onclick=()=>{
    isPlaying=!isPlaying;
    playBtn.textContent=isPlaying?'â¸ Pause':'â–¶ Play';
    last=performance.now();
  };

  function lerpColor(c1,c2,t){
    const a=new THREE.Color(c1);
    const b=new THREE.Color(c2);
    return a.lerp(b,t);
  }

  function animate(ts){
    requestAnimationFrame(animate);

    if(isPlaying && ts-last>16){
      time.value = Math.min(100, parseFloat(time.value)+0.25*parseFloat(speed.value));
      last=ts;
    }

    const t = parseFloat(time.value)/100;
    const posArr = geo.attributes.position.array;
    const colArr = geo.attributes.color.array;

    const c1=new THREE.Color(0x99ccff);
    const c2=new THREE.Color(0xffdd99);
    const c3=new THREE.Color(0xff9a66);
    const gcol = (t<0.6) ? lerpColor(c1,c2,t/0.6) : lerpColor(c2,c3,(t-0.6)/0.4);

    let core=0, wMean=0;
    const sn = parseFloat(snRate.value);

    for(let i=0;i<COUNT;i++){
      const rr = r0[i];
      const aa = ang0[i];
      const yy = y0[i];

      const settle = 1-0.55*t*Math.exp(-t*1.8);
      const r = Math.max(6, rr*settle);
      const w = omega0[i]*(1+1.6*t);

      const angle = aa + w*(t*8) + (type==='milkyway'?Math.sin(aa*4)*0.3*t:0);
      const y = yy*(0.6+0.4*Math.cos(t*2.5));

      posArr[i*3]  = r*Math.cos(angle);
      posArr[i*3+1]= y;
      posArr[i*3+2]= r*Math.sin(angle);

      if(r<120) core++;
      wMean += w;

      colArr[i*3]  = gcol.r;
      colArr[i*3+1]= gcol.g;
      colArr[i*3+2]= gcol.b;

      if(snTimer[i]<=0 && Math.random()<sn){
        snTimer[i]=1;
      }
      if(snTimer[i]>0){
        const k=snTimer[i];
        colArr[i*3]  = Math.min(1,gcol.r+0.8*k);
        colArr[i*3+1]= Math.min(1,gcol.g+0.8*k);
        colArr[i*3+2]= Math.min(1,gcol.b+0.8*k);
        snTimer[i]   = Math.max(0, snTimer[i]-0.04-0.02*Math.random());
      }
    }

    geo.attributes.position.needsUpdate=true;
    geo.attributes.color.needsUpdate=true;

    mat.size    = 2+2.2*t;
    mat.opacity = 0.85+0.15*Math.sin(t*Math.PI);
    stars.rotation.y += 0.0008 + t*0.0008;

    statsEl.textContent = `t=${t.toFixed(2)} | âŸ¨Ï‰âŸ©=${(wMean/COUNT).toFixed(3)} | core Ï=${core} | N=${COUNT}`;

    renderer.render(scene,camera);
  }
  animate();
}

/* ---------- ë’¤ë¡œê°€ê¸° ---------- */
document.getElementById('backBtn').onclick=()=>{
  const entry = {
    type:selectedGalaxy,
    time:time.value,
    speed:speed.value,
    snRate:snRate.value,
    saved:new Date().toLocaleTimeString()
  };
  addHistory(entry);
  renderHistoryList();

  hud.style.display='none';
  panel.style.display='none';
  playbox.style.display='none';
  backbox.style.display='none';
  menu.style.display='flex';

  isPlaying=false;
  playBtn.textContent='â–¶ Play';
};

/* ---------- ë¦¬ì‚¬ì´ì¦ˆ ---------- */
addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
  updateCam();
});

/* ---------- ì´ˆê¸° íˆìŠ¤í† ë¦¬ ---------- */
renderHistoryList();
</script>
</body>
</html>
